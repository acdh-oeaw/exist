From 0c69e64cc18130332be989601ed7dee799f408f4 Mon Sep 17 00:00:00 2001
From: Omar Siam <Omar.Siam@oeaw.ac.at>
Date: Sun, 12 Dec 2021 21:23:07 +0100
Subject: [PATCH 7/7] Prevent Log4Shell CVE-2021-44228

---
 exist-distribution/src/main/config/log4j2.xml | 8 ++++----
 exist-parent/pom.xml                          | 2 +-
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/exist-distribution/src/main/config/log4j2.xml b/exist-distribution/src/main/config/log4j2.xml
index c415025404..f5dc6fe83e 100644
--- a/exist-distribution/src/main/config/log4j2.xml
+++ b/exist-distribution/src/main/config/log4j2.xml
@@ -5,13 +5,13 @@
         <Property name="rollover.max.size">10MB</Property>
         <Property name="rollover.max">14</Property>
         <Property name="rollover.file.pattern">%d{yyyyMMddHHmmss}</Property>
-        <Property name="exist.file.pattern">%d [%t] %-5p (%F [%M]:%L) - %m %n</Property>
+        <Property name="exist.file.pattern">%d [%t] %-5p (%F [%M]:%L) - %m{noLookups} %n</Property>
     </Properties>
     
     <Appenders>
         
         <Console name="STDOUT">
-            <PatternLayout pattern="%d{DATE} [%t] %-5p (%F [%M]:%L) - %m %n"/>
+            <PatternLayout pattern="%d{DATE} [%t] %-5p (%F [%M]:%L) - %m{noLookups} %n"/>
         </Console>
         
         <RollingRandomAccessFile name="exist.core" filePattern="${logs}/exist.${rollover.file.pattern}.log.gz" fileName="${logs}/exist.log">
@@ -27,7 +27,7 @@
                 <SizeBasedTriggeringPolicy size="${rollover.max.size}"/>
             </Policies>
             <DefaultRolloverStrategy max="${rollover.max}"/>
-            <PatternLayout pattern="%d %-5p - %m %n"/>
+            <PatternLayout pattern="%d %-5p - %m{noLookups} %n"/>
         </RollingRandomAccessFile>
 
         <RollingRandomAccessFile name="exist.ensurelocking" filePattern="${logs}/locks.${rollover.file.pattern}.log.gz" fileName="${logs}/ensure-locking.log">
@@ -35,7 +35,7 @@
                 <SizeBasedTriggeringPolicy size="${rollover.max.size}"/>
             </Policies>
             <DefaultRolloverStrategy max="${rollover.max}"/>
-            <PatternLayout pattern="%d %-5p - %m %n"/>
+            <PatternLayout pattern="%d %-5p - %m{noLookups} %n"/>
         </RollingRandomAccessFile>
 
         <RollingRandomAccessFile name="exist.xmldb" filePattern="${logs}/xmldb.${rollover.file.pattern}.log.gz" fileName="${logs}/xmldb.log">
diff --git a/exist-parent/pom.xml b/exist-parent/pom.xml
index 4e6e47fb1d..4d69e1cdf3 100644
--- a/exist-parent/pom.xml
+++ b/exist-parent/pom.xml
@@ -111,7 +111,7 @@
         <jaxb.api.version>3.0.1</jaxb.api.version>
         <jaxb.impl.version>3.0.1</jaxb.impl.version>
         <jetty.version>9.4.44.v20210927</jetty.version>
-        <log4j.version>2.14.1</log4j.version>
+        <log4j.version>2.17.1</log4j.version>
         <lucene.version>4.10.4</lucene.version>
         <milton.version>1.8.1.3</milton.version>
         <saxon.version>9.9.1-8</saxon.version>
-- 
2.34.1.windows.1

